name: Delete Infra Test Composer Every Weeknight

on:
  schedule:
    - cron: '0 1 * * 2-6'  # At 01:00 UTC, Tues-Sat, which is Mon-Fri 6 PM MST
  workflow_dispatch:

jobs:
  delete-composer:
    if: github.repository == 'SatcherInstitute/health-equity-tracker'
    runs-on: ubuntu-latest

    steps:
      - id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.TEST_DEPLOYER_SA_KEY }}
      - name: Set Up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.TEST_PROJECT_ID }}
      - name: Delete Composer
        id: turn-off-composer
        run: |
          gcloud composer environments delete data-ingestion-environment --quiet --location=us-central1
